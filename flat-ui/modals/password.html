<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰øÆÊîπÂØÜÁ†Å</title>
    <style>
        /* Password Modal Inline CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
            color: #333;
            padding: 20px;
        }

        .modal-container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e8e8e8;
            background: #fafafa;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .form-item {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .form-field {
            position: relative;
        }

        .form-field input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-field input:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .form-field input:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        /* Password field with left eye icon */
        .pwd-field {
            position: relative;
            display: flex;
            align-items: center;
        }

        .pwd-field input {
            padding-left: 34px;
        }

        .pwd-eye {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-radius: 3px;
            transition: background-color 0.3s;
        }

        .pwd-eye:hover {
            background: rgba(0,0,0,0.05);
        }

        .pwd-eye:focus {
            outline: 1px solid #40a9ff;
        }

        /* Password field with actions */
        .with-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .with-actions .pwd-field {
            flex: 1;
        }

        .pwd-mini-actions {
            display: flex;
            gap: 6px;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-xs:hover {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        /* Password strength */
        .pwd-strength-wrap {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pwd-strength-bg {
            flex: 1;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .pwd-strength-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff4d4f, #ffa940, #52c41a);
            transition: width 0.3s;
        }

        .pwd-strength-bar[data-level="Âº±"] {
            background: #ff4d4f;
        }

        .pwd-strength-bar[data-level="‰∏≠"] {
            background: #ffa940;
        }

        .pwd-strength-bar[data-level="Âº∫"] {
            background: #52c41a;
        }

        .pwd-strength-label {
            font-size: 12px;
            color: #666;
            min-width: 30px;
        }

        /* Messages */
        .pwd-inline-msg {
            font-size: 12px;
            margin-top: 6px;
            min-height: 18px;
        }

        .pwd-inline-msg.err {
            color: #ff4d4f;
        }

        .pwd-inline-msg.ok {
            color: #52c41a;
        }

        .pwd-rules {
            margin: 8px 0 0 0;
            padding-left: 16px;
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .pwd-rules li {
            margin-bottom: 2px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #f0f0f0;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            background: white;
            color: #666;
        }

        .btn-primary {
            background: #1890ff;
            border-color: #1890ff;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #40a9ff;
            border-color: #40a9ff;
        }

        .btn:hover:not(.btn-primary):not(:disabled) {
            border-color: #40a9ff;
            color: #40a9ff;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .req {
            color: #ff4d4f;
        }

        /* Responsive */
        @media (max-width: 640px) {
            body {
                padding: 12px;
            }
            
            .modal-container {
                max-width: 100%;
            }
            
            .with-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .pwd-mini-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="modal-container">
        <div class="modal-header">
            <h2>‰øÆÊîπÂØÜÁ†Å</h2>
        </div>
        <div class="modal-body">
            <form id="pwdForm" autocomplete="off">
                <div class="form-item">
                    <label class="form-label">Áî®Êà∑</label>
                    <div class="form-field">
                        <input class="readonly" value="testuser (1)" disabled />
                    </div>
                </div>

                <div class="form-item" id="oldPasswordField" style="display:none;">
                    <label class="form-label">ÊóßÂØÜÁ†Å <span class="req">*</span></label>
                    <div class="form-field pwd-field">
                        <button type="button" class="pwd-eye" title="ÊòæÁ§∫/ÈöêËóè">üëÅ</button>
                        <input type="password" name="oldpwd" placeholder="ËæìÂÖ•ÂΩìÂâçÂØÜÁ†Å" minlength="1" autocomplete="current-password" required />
                    </div>
                </div>

                <div class="form-item">
                    <label class="form-label">Êñ∞ÂØÜÁ†Å <span class="req">*</span></label>
                    <div class="form-field with-actions">
                        <div class="pwd-field">
                            <button type="button" class="pwd-eye" title="ÊòæÁ§∫/ÈöêËóè">üëÅ</button>
                            <input type="password" name="pwd1" id="pwd1" placeholder="Ëá≥Â∞ë8‰ΩçÔºåÂê´2ÁßçÁ±ªÂà´" minlength="8" autocomplete="new-password" required />
                        </div>
                        <div class="pwd-mini-actions">
                            <button type="button" class="btn-xs" id="btnGenPwd" title="ÁîüÊàêÈöèÊú∫Âº∫ÂØÜÁ†Å">ÁîüÊàê</button>
                            <button type="button" class="btn-xs" id="btnCopyPwd" title="Â§çÂà∂ÂΩìÂâçÂØÜÁ†Å">Â§çÂà∂</button>
                        </div>
                    </div>
                    <div class="pwd-strength-wrap">
                        <div class="pwd-strength-bg">
                            <div id="pwdStrengthBar" class="pwd-strength-bar" data-level=""></div>
                        </div>
                        <span id="pwdStrengthLabel" class="pwd-strength-label"></span>
                    </div>
                </div>

                <div class="form-item">
                    <label class="form-label">Á°ÆËÆ§ÂØÜÁ†Å <span class="req">*</span></label>
                    <div class="form-field pwd-field">
                        <button type="button" class="pwd-eye" title="ÊòæÁ§∫/ÈöêËóè">üëÅ</button>
                        <input type="password" name="pwd2" id="pwd2" placeholder="ÂÜçÊ¨°ËæìÂÖ•Êñ∞ÂØÜÁ†Å" minlength="8" autocomplete="new-password" required />
                    </div>
                </div>

                <div class="form-item">
                    <div id="pwdInlineMsg" class="pwd-inline-msg"></div>
                    <ul class="pwd-rules">
                        <li id="oldPwdRule" style="display:none;">Êú¨‰∫∫‰øÆÊîπÈúÄËæìÂÖ•ÊóßÂØÜÁ†Å</li>
                        <li>ÈïøÂ∫¶ ‚â• 8</li>
                        <li>Ëá≥Â∞ë 2 Á±ªÂ≠óÁ¨¶ÔºàÂ§ßÂÜô/Â∞èÂÜô/Êï∞Â≠ó/Á¨¶Âè∑Ôºâ</li>
                        <li>‰∏§Ê¨°Êñ∞ÂØÜÁ†Å‰∏ÄËá¥</li>
                    </ul>
                </div>

                <div class="form-actions">
                    <button type="submit" id="btnPwdSubmit" class="btn btn-primary" disabled>Á°ÆËÆ§</button>
                    <button type="button" class="btn" onclick="window.close()">ÂèñÊ∂à</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Password Modal JavaScript
        (function() {
            'use strict';

            const form = document.getElementById('pwdForm');
            const pwd1 = document.getElementById('pwd1');
            const pwd2 = document.getElementById('pwd2');
            const oldPwdField = document.getElementById('oldPasswordField');
            const oldPwdRule = document.getElementById('oldPwdRule');
            const submitBtn = document.getElementById('btnPwdSubmit');
            const msgEl = document.getElementById('pwdInlineMsg');
            const strengthBar = document.getElementById('pwdStrengthBar');
            const strengthLabel = document.getElementById('pwdStrengthLabel');

            let selfChange = false; // Will be set based on URL params

            // Initialize
            init();

            function init() {
                parseURLParams();
                setupPasswordEnhance();
                form.addEventListener('submit', onSubmit);
                validate();
            }

            function parseURLParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const isSelfChange = urlParams.get('selfChange') === 'true';
                const userData = urlParams.get('userData');

                if (isSelfChange) {
                    selfChange = true;
                    oldPwdField.style.display = '';
                    oldPwdRule.style.display = '';
                }

                if (userData) {
                    try {
                        const user = JSON.parse(decodeURIComponent(userData));
                        const userDisplay = `${user.userAccount || 'unknown'} (${user.userId || 0})`;
                        form.querySelector('.readonly').value = userDisplay;
                    } catch (e) {
                        console.error('Failed to parse user data:', e);
                    }
                }
            }

            function setupPasswordEnhance() {
                // Eye buttons
                form.querySelectorAll('.pwd-eye').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const input = btn.parentElement.querySelector('input');
                        if (!input) return;
                        if (input.type === 'password') {
                            input.type = 'text';
                            btn.textContent = 'üôà';
                        } else {
                            input.type = 'password';
                            btn.textContent = 'üëÅ';
                        }
                    });
                });

                // Generate password
                document.getElementById('btnGenPwd').addEventListener('click', async () => {
                    const newPwd = generateStrongPassword(12);
                    pwd1.value = newPwd;
                    pwd2.value = newPwd;
                    validate();
                    try {
                        await copyToClipboard(newPwd);
                        alert('Â∑≤ÁîüÊàêÂπ∂Â§çÂà∂');
                    } catch {
                        alert('Â∑≤ÁîüÊàêÔºåÂ§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
                    }
                });

                // Copy password
                document.getElementById('btnCopyPwd').addEventListener('click', async () => {
                    if (!pwd1.value) {
                        alert('Êó†ÂèØÂ§çÂà∂ÂØÜÁ†Å');
                        return;
                    }
                    try {
                        await copyToClipboard(pwd1.value);
                        alert('Â∑≤Â§çÂà∂ÂØÜÁ†Å');
                    } catch {
                        alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂');
                    }
                });

                // Validation
                pwd1.addEventListener('input', validate);
                pwd2.addEventListener('input', validate);
                if (selfChange) {
                    form.querySelector('input[name=oldpwd]').addEventListener('input', validate);
                }
            }

            function validate() {
                const oldPwdVal = selfChange ? form.querySelector('input[name=oldpwd]').value : '';
                const v1 = pwd1.value;
                const v2 = pwd2.value;
                const { ok, msg, score, level } = validatePassword(v1, v2, selfChange, oldPwdVal);
                
                renderStrength(score, level);
                msgEl.textContent = msg;
                msgEl.className = 'pwd-inline-msg ' + (ok ? 'ok' : 'err');
                submitBtn.disabled = !ok;
            }

            function renderStrength(score, level) {
                const percent = Math.min(100, Math.round(score));
                strengthBar.style.width = percent + '%';
                strengthBar.dataset.level = level;
                strengthLabel.textContent = level ? level.toUpperCase() : '';
            }

            function validatePassword(pwd1, pwd2, selfChange, oldPwdVal) {
                const res = { ok: false, msg: '', score: 0, level: '' };

                if (selfChange && !oldPwdVal) {
                    res.msg = 'ËØ∑ËæìÂÖ•ÊóßÂØÜÁ†Å';
                    return res;
                }
                if (!pwd1) { res.msg = 'ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å'; return res; }
                if (pwd1.length < 8) { res.msg = 'Êñ∞ÂØÜÁ†Å‰∏çË∂≥ 8 ‰Ωç'; return res; }

                let classes = 0;
                if (/[a-z]/.test(pwd1)) classes++;
                if (/[A-Z]/.test(pwd1)) classes++;
                if (/\d/.test(pwd1)) classes++;
                if (/[^A-Za-z0-9]/.test(pwd1)) classes++;

                if (classes < 2) { res.msg = 'Ëá≥Â∞ëÂåÖÂê´ 2 Á±ªÂ≠óÁ¨¶'; return res; }
                if (!pwd2) { res.msg = 'ËØ∑ÂÜçÊ¨°ËæìÂÖ•Á°ÆËÆ§ÂØÜÁ†Å'; return res; }
                if (pwd1 !== pwd2) { res.msg = '‰∏§Ê¨°ÂØÜÁ†Å‰∏ç‰∏ÄËá¥'; return res; }

                let score = Math.min(60, pwd1.length * 4);
                score += (classes - 2) * 15;
                if (/([A-Za-z0-9])\1{2,}/.test(pwd1)) score -= 10;
                score = Math.max(0, Math.min(100, score));

                let level = 'Âº±';
                if (score >= 75) level = 'Âº∫';
                else if (score >= 50) level = '‰∏≠';

                res.ok = true;
                res.msg = 'ÂØÜÁ†ÅÂêàÊ≥ï';
                res.score = score;
                res.level = level;
                return res;
            }

            function generateStrongPassword(len = 12) {
                const pools = {
                    upper: 'ABCDEFGHJKLMNPQRSTUVWXYZ',
                    lower: 'abcdefghijkmnopqrstuvwxyz',
                    digit: '23456789',
                    symbol: '!@#$%^&*?_+-=~'
                };
                const pick = s => s[Math.floor(Math.random() * s.length)];
                let base = [pick(pools.upper), pick(pools.lower), pick(pools.digit), pick(pools.symbol)];
                const all = pools.upper + pools.lower + pools.digit + pools.symbol;
                while (base.length < len) base.push(pick(all));
                for (let i = base.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [base[i], base[j]] = [base[j], base[i]];
                }
                return base.join('');
            }

            function copyToClipboard(text) {
                return new Promise(async (resolve, reject) => {
                    if (navigator.clipboard && window.isSecureContext) {
                        try {
                            await navigator.clipboard.writeText(text);
                            return resolve(true);
                        } catch (e) {
                            // Continue to fallback
                        }
                    }
                    try {
                        const ta = document.createElement('textarea');
                        ta.value = text;
                        ta.setAttribute('readonly', '');
                        ta.style.position = 'fixed';
                        ta.style.left = '-9999px';
                        ta.style.top = '0';
                        document.body.appendChild(ta);
                        ta.select();
                        const ok = document.execCommand('copy');
                        ta.remove();
                        if (ok) return resolve(true);
                        return reject(new Error('execCommand copy failed'));
                    } catch (err) {
                        return reject(err);
                    }
                });
            }

            function onSubmit(e) {
                e.preventDefault();
                if (submitBtn.disabled) return;
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                console.log('Changing password:', { ...data, pwd1: '[HIDDEN]', pwd2: '[HIDDEN]', oldpwd: '[HIDDEN]' });
                alert('Ê®°ÊãüÂØÜÁ†Å‰øÆÊîπÊàêÂäüÔºÅ');
                
                // In real implementation, call API here
                // window.close();
            }
        })();
    </script>
</body>
</html>