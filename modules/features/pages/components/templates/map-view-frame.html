<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>MapView Frame</title>
  <style>
    html,body,#map{height:100%;margin:0;padding:0;background:#0a0f14}
    *{box-sizing:border-box}

    /* 关键修复：禁用地图区域的文本选择和点击高亮，避免出现蓝色选区 */
    html, body, #map,
    .amap-canvas, .amap-layer, .amap-marker, .amap-marker-label,
    .amap-overlay-text, .amap-info, .ov-wrap, .ov-wrap * {
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    /* 图片与标注不允许被拖动成选区影像 */
    img, .amap-marker img { -webkit-user-drag: none; user-drag: none; }

    /* 信息窗固定尺寸：宽度固定，高度在打开后锁定 */
    .ov-wrap{width:380px;background:#111c28;color:#cfd8dc;border:1px solid rgba(255,255,255,.12);border-radius:6px;box-shadow:0 8px 22px rgba(0,0,0,.45);overflow:hidden;}
    .ov-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);font-weight:600;}
    .ov-bd{padding:10px 12px;font-size:12px;line-height:1.7;}
    .ov-actions{padding:0 12px 12px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
    .btn{padding:4px 8px;background:#1f497d;border:1px solid rgba(255,255,255,.15);color:#e6f0ff;border-radius:4px;cursor:pointer;}
    select{background:#15202a;color:#e6f0ff;border:1px solid rgba(255,255,255,.15);border-radius:4px;padding:3px 6px;}
    .ov-close{background:transparent;border:none;color:#ccd;cursor:pointer;}
    .ov-close:hover{color:#fff;}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    (function(){
      var AMAP_KEY = '';
      var debug = false;

      var log=function(){ if(debug) try{ console.info.apply(console, ["[MapView-IFRAME]"].concat([].slice.call(arguments))); }catch(e){} };
      var warn=function(){ if(debug) try{ console.warn.apply(console, ["[MapView-IFRAME]"].concat([].slice.call(arguments))); }catch(e){} };
      var post=function(msg){ try{ parent.postMessage(Object.assign({__mv:true},msg),"*"); }catch(e){} };

      var map=null,markers=[],infoWindow=null,followCenter=false,mounted=false,currentDevInfo=null;

      function ensureAMap(cb){
        if(!AMAP_KEY){ post({t:"error",message:"缺少高德 Key（AMAP_KEY）"}); return; }
        if(window.AMap){ cb&&cb(); return; }
        var s=document.createElement("script");
        s.src="https://webapi.amap.com/maps?v=2.0&key="+encodeURIComponent(AMAP_KEY);
        s.onload=function(){ cb&&cb(); };
        s.onerror=function(){ post({t:"error",message:"高德 SDK 加载失败"}); };
        document.head.appendChild(s);
      }

      function init(){
        try{
          map=new AMap.Map("map",{zoom:5,center:[105,35],viewMode:"2D",dragEnable:true,scrollWheel:true,keyboardEnable:true,doubleClickZoom:true});
          try{ map.setStatus({dragEnable:true,scrollWheel:true,keyboardEnable:true,doubleClickZoom:true}); }catch(e){}
          mounted=true;
          map.on && map.on("complete", function(){ post({t:"ready"}); log("map complete"); });

          /* 关键修复：任何交互都清除浏览器选区，避免蓝色选区残留 */
          var clearSel=function(){ try{ var s=window.getSelection && window.getSelection(); if(s&&s.removeAllRanges) s.removeAllRanges(); }catch(e){} };
          map.on && map.on("click", clearSel);
          map.on && map.on("mousemove", clearSel);
          map.on && map.on("dragstart", clearSel);
          map.on && map.on("zoomstart", clearSel);
          document.addEventListener("mouseup", clearSel, true);

          map.on && map.on("mapmove", function(){
            if(followCenter&&infoWindow){ try{ infoWindow.setPosition(map.getCenter()); }catch(e){} }
          });
        }catch(e){
          warn("init error",e); post({t:"error",message:"地图初始化失败"});
        }
      }

      function clearMarkers(){ for(var i=0;i<markers.length;i++){ try{ markers[i].setMap(null); }catch(e){} } markers=[]; }
      function setMarkers(list){
        if(!mounted) return;
        clearMarkers();
        var cnt=0;
        (list||[]).forEach(function(e){
          var d=e.devInfo||e;
          if(!d||!d.lastLocation||d.lastLocation.lng==null||d.lastLocation.lat==null) return;
          var mk=new AMap.Marker({
            position:[d.lastLocation.lng,d.lastLocation.lat],
            title:d.no,
            draggable:false,  // 显式不可拖拽
            bubble:true
          });
          mk.on("click", function(){ post({t:"markerClick", devId:d.id}); });
          mk.setMap(map); markers.push(mk); cnt++;
        });
        log("markers set", cnt);
      }

      function lockSizeOnce(el){
        try{
          var r=el.getBoundingClientRect();
          el.style.width=Math.round(r.width)+"px";
          el.style.height=Math.round(r.height)+"px";
        }catch(e){}
      }

      function openDevice(devInfo, followCenterWhenNoLocation){
        if(!mounted) return;
        currentDevInfo = devInfo || {};
        var pos;
        if(currentDevInfo.lastLocation && currentDevInfo.lastLocation.lng!=null && currentDevInfo.lastLocation.lat!=null){
          pos=[currentDevInfo.lastLocation.lng,currentDevInfo.lastLocation.lat];
          followCenter=false;
        } else {
          pos=map.getCenter();
          followCenter=!!followCenterWhenNoLocation;
        }

        var options = (currentDevInfo.modeList||[]).map(function(m){
          var id = (m && m.modeId!=null) ? m.modeId : "";
          var name = (m && (m.modeName||m.name)) ? (m.modeName||m.name) : "";
          return '<option value="'+ String(id) +'">'+ String(name) +'</option>';
        }).join('');

        var posText = currentDevInfo.lastLocation
          ? (currentDevInfo.lastLocation.lat + "," + currentDevInfo.lastLocation.lng + (currentDevInfo.lastLocation.height!=null?(" 高度:"+currentDevInfo.lastLocation.height+"m"):""))
          : "无定位数据";
        var timeText = currentDevInfo.lastLocation ? new Date(currentDevInfo.lastLocation.time).toLocaleString() : "";
        var onlineTag = currentDevInfo.onlineState
          ? '<span style="font-size:12px;color:#7ef58b;margin-left:6px;">在线</span>'
          : '<span style="font-size:12px;color:#99a;margin-left:6px;">离线</span>';

        var html =
          '<div class="ov-hd">'
            + '<div>'+ (currentDevInfo.no || String(currentDevInfo.id||"")) +' '+ onlineTag +'</div>'
            + '<button id="ovCloseBtn" class="ov-close">✕</button>'
          + '</div>'
          + '<div class="ov-bd">'
            + '<div>位置：'+ posText +'</div>'
            + '<div>更新时间：'+ timeText +'  速度：'+ (currentDevInfo.lastLocation ? ((currentDevInfo.lastLocation.speed||0) + ' km/h') : '') +'</div>'
          + '</div>'
          + '<div class="ov-actions">'
            + '<button class="btn" id="btnOpenVideo">打开视频</button>'
            + '<label>设备模式：<select id="ovModeSel">'+ options +'</select></label>'
            + '<button class="btn" id="btnOpenMode">打开模式</button>'
            + '<button class="btn" id="btnRefreshInfo" style="margin-left:auto;background:#203246">刷新</button>'
          + '</div>';

        var w=document.createElement("div"); w.className="ov-wrap"; w.innerHTML = html;
        if(!infoWindow) infoWindow=new AMap.InfoWindow({ isCustom:true, offset:new AMap.Pixel(0,-20), closeWhenClickMap:true });
        infoWindow.setContent(w); infoWindow.open(map,pos);

        // 打开后锁定尺寸，后续不再变化
        setTimeout(function(){ lockSizeOnce(w); }, 0);
        setTimeout(function(){ lockSizeOnce(w); }, 60);

        // 信息窗内部也不产生选区
        w.addEventListener('mousedown', function(){ try{ var s=window.getSelection(); if(s) s.removeAllRanges(); }catch(e){} }, true);

        w.querySelector("#ovCloseBtn").addEventListener("click",function(){ try{ infoWindow&&infoWindow.close(); }catch(e){} });
        w.querySelector("#btnOpenVideo").addEventListener("click",function(){ post({ t:"openVideo", devId: currentDevInfo.id, devNo: currentDevInfo.no }); });
        w.querySelector("#btnOpenMode").addEventListener("click",function(){
          var sel=w.querySelector("#ovModeSel"); var modeId = sel && sel.value;
          post({ t:"openMode", devId: currentDevInfo.id, devNo: currentDevInfo.no, modeId: modeId });
        });
        w.querySelector("#btnRefreshInfo").addEventListener("click",function(){ post({ t:"refreshDevice", devId: currentDevInfo.id }); });
        log("openDevice", pos);
      }

      function setCenter(lng,lat){ try{ map&&map.setCenter([lng,lat]); }catch(e){} }
      function resize(){ try{ map&&map.resize(); }catch(e){} }

      // 等父页面发来 init 后再加载 SDK
      window.addEventListener("message", function(e){
        var msg=e.data||{}; if(!msg.__mv) return;
        switch(msg.t){
          case "init":
            AMAP_KEY = (msg.key || "").trim();
            debug = !!msg.debug;
            ensureAMap(init);
            break;
          case "setMarkers": setMarkers(msg.list||[]); break;
          case "openDevice": openDevice(msg.devInfo||{}, !!msg.followCenterWhenNoLocation); break;
          case "setCenter": setCenter(msg.lng, msg.lat); break;
          case "resize": resize(); break;
        }
      }, { capture:true });
    })();
  </script>
</body>
</html>