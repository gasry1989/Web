<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>MapView Frame</title>
  <style>
    html,body,#map{height:100%;margin:0;padding:0;background:#0a0f14}
    *{box-sizing:border-box}
    html, body, #map,
    .amap-canvas, .amap-layer, .amap-marker, .amap-marker-label,
    .amap-overlay-text, .amap-info { -webkit-user-select:none; -moz-user-select:none; user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent; }
    img, .amap-marker img { -webkit-user-drag:none; user-drag:none; }
    .ov-iframe{display:block; width:420px; height:10px; border:0; background:transparent;}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    (function(){
      var AMAP_KEY = '';
      var SECURITY_JS_CODE = '';
      var debug = true;

      var log=function(){ if(debug) try{ console.info.apply(console, ["[MapView-IFRAME]"].concat([].slice.call(arguments))); }catch(e){} };
      var warn=function(){ if(debug) try{ console.warn.apply(console, ["[MapView-IFRAME]"].concat([].slice.call(arguments))); }catch(e){} };
      var post=function(msg){ try{ parent.postMessage(Object.assign({__mv:true},msg),"*"); }catch(e){} };

      var map=null,markers=[],infoWindow=null, geocoder=null, mounted=false;
      var infoFrame=null, infoWindowOpen=false;

      var currentDevInfo=null;
      var currentShownDevId=null;        // 正在信息窗里显示的设备
      var lastInfoPos=null;              // {lng,lat} 数值坐标，作为“默认位置”
      var openedDevIds = Object.create(null); // 仅用于日志与可能的扩展

      function ensureAMap(cb){
        if(!AMAP_KEY){ post({t:"error",message:"缺少高德 Key（AMAP_KEY）"}); return; }
        if(window.AMap){ cb&&cb(); return; }
        try{ if (SECURITY_JS_CODE) window._AMapSecurityConfig = { securityJsCode: SECURITY_JS_CODE }; }catch(e){}
        var s=document.createElement("script");
        s.src="https://webapi.amap.com/maps?v=2.0&key="+encodeURIComponent(AMAP_KEY);
        s.onload=function(){ cb&&cb(); };
        s.onerror=function(){ post({t:"error",message:"高德 SDK 加载失败"}); };
        document.head.appendChild(s);
      }
      function ensureGeocoder(cb) {
        try {
          if (geocoder) { cb && cb(); return; }
          if (!window.AMap) return;
          if (AMap.Geocoder) { geocoder = new AMap.Geocoder(); cb && cb(); }
          else if (AMap.plugin) { AMap.plugin('AMap.Geocoder', function(){ geocoder = new AMap.Geocoder(); cb && cb(); }); }
        } catch(e) { warn('geocoder init error', e); }
      }

      function init(){
        try{
          map=new AMap.Map("map",{zoom:5,center:[105,35],viewMode:"2D",dragEnable:true,scrollWheel:true,keyboardEnable:true,doubleClickZoom:true});
          try{ map.setStatus({dragEnable:true,scrollWheel:true,keyboardEnable:true,doubleClickZoom:true}); }catch(e){}
          mounted=true;
          map.on && map.on("complete", function(){ post({t:"ready"}); });

          var clearSel=function(){ try{ var s=window.getSelection && window.getSelection(); if(s&&s.removeAllRanges) s.removeAllRanges(); }catch(e){} };
          // 我们能控制的监听尽量 passive，SDK 内部的警告可忽略
          map.on && map.on("click", clearSel, { passive:true });
          map.on && map.on("mousemove", clearSel, { passive:true });
          map.on && map.on("dragstart", clearSel, { passive:true });
          map.on && map.on("zoomstart", clearSel, { passive:true });
          document.addEventListener("mouseup", clearSel, true);
        }catch(e){
          warn("init error",e); post({t:"error",message:"地图初始化失败"});
        }
      }

      function clearMarkers(){ for(var i=0;i<markers.length;i++){ try{ markers[i].setMap(null); }catch(e){} } markers=[]; }
      function setMarkers(list){
        if(!mounted) return;
        clearMarkers();
        (list||[]).forEach(function(e){
          var d=e.devInfo||e;
          if(!d||!d.lastLocation||d.lastLocation.lng==null||d.lastLocation.lat==null) return;
          var mk=new AMap.Marker({ position:[d.lastLocation.lng,d.lastLocation.lat], title:d.no||d.id, draggable:false, bubble:true });
          mk.on("click", function(){ post({t:"markerClick", devId:d.id}); });
          mk.setMap(map); markers.push(mk);
        });
      }

      function lockWidth(el){ try{ var r=el.getBoundingClientRect(); el.style.width=Math.round(r.width)+"px"; }catch(e){} }
      function fmtCoord(lat,lng,isNorth,isEast){
        var latS = (Math.abs(lat).toFixed(6)) + '°';
        var lngS = (Math.abs(lng).toFixed(6)) + '°';
        function ori(bTrue, posChar){ return bTrue===false ? (posChar==='N'?'S':'W') : posChar; }
        return ori(isNorth,'N') + ' ' + latS + ', ' + ori(isEast,'E') + ' ' + lngS;
      }
      function buildData(devInfo){
        var hasLL = !!(devInfo && devInfo.lastLocation && devInfo.lastLocation.lng!=null && devInfo.lastLocation.lat!=null);
        var posText = hasLL
          ? (fmtCoord(devInfo.lastLocation.lat, devInfo.lastLocation.lng, devInfo.lastLocation.isNorth, devInfo.lastLocation.isEast)
             + (devInfo.lastLocation.height!=null? ('   ' + Number(devInfo.lastLocation.height) + 'm'):''))
          : "无定位数据";
        var timeText = devInfo && devInfo.lastLocation ? new Date(devInfo.lastLocation.time).toLocaleString() : "";
        var speedText = devInfo && devInfo.lastLocation ? ((devInfo.lastLocation.speed||0) + ' km/h') : '';
        var modeList = Array.isArray(devInfo && devInfo.modeList) ? devInfo.modeList : [];
        var camCount = (devInfo && devInfo.hardwareInfo && Number(devInfo.hardwareInfo.cameraCount)) || 0;
        return { devInfo:devInfo||{}, hasLL:hasLL, posText:posText, timeText:timeText, speedText:speedText, modeList:modeList, camCount:camCount };
      }

      function ensureInfoContent(){
        if (!infoWindow) infoWindow = new AMap.InfoWindow({ isCustom:true, offset:new AMap.Pixel(0,-20), closeWhenClickMap:false });
        if (!infoFrame) {
          var ifr=document.createElement('iframe');
          ifr.className='ov-iframe';
          ifr.src='/modules/features/pages/components/map-info-frame.html';
          ifr.addEventListener('load', function(){
            setTimeout(function(){ lockWidth(ifr); }, 0);
            setTimeout(function(){ lockWidth(ifr); }, 60);
          });
          infoFrame = ifr;
          infoWindow.setContent(infoFrame);
        }
      }

      function sendDataToChild(){
        try{
          if (infoFrame && infoFrame.contentWindow) {
            infoFrame.contentWindow.postMessage({ __iv:true, t:'setData', data: buildData(currentDevInfo) }, '*');
          }
        }catch(e){}
      }

      // 固定且稳定的默认坐标：首次使用时从当前地图中心缓存为数值
      function defaultPosArray(){
        if (!lastInfoPos) {
          try{
            var c = map.getCenter();
            lastInfoPos = { lng: Number(c.lng), lat: Number(c.lat) };
          }catch(e){
            lastInfoPos = { lng:105, lat:35 };
          }
        }
        return [ lastInfoPos.lng, lastInfoPos.lat ];
      }

      // 打开/更新信息窗（修正版：切换到“无经纬度”设备不移动）
      function openDevice(devInfo, followCenterWhenNoLocation){
        if(!mounted) return;
        currentDevInfo = devInfo || {};
        var devId = currentDevInfo && currentDevInfo.id!=null ? String(currentDevInfo.id) : null;
        var hasLL = !!(currentDevInfo && currentDevInfo.lastLocation && currentDevInfo.lastLocation.lng!=null && currentDevInfo.lastLocation.lat!=null);
        var ll = hasLL ? [ Number(currentDevInfo.lastLocation.lng), Number(currentDevInfo.lastLocation.lat) ] : null;

        ensureInfoContent();

        var action = '';      // 'open-default' | 'open-ll' | 'move-ll' | 'stay'
        var target = null;    // [lng,lat] 或 null

        if (!infoWindowOpen) {
          if (hasLL) { action='open-ll'; target=ll; }
          else { action='open-default'; target=defaultPosArray(); }
          try { infoWindow.open(map, target); infoWindowOpen = true; } catch(e){}
        } else {
          // 已有信息窗：仅在“有经纬度”时才移动，切到“无经纬度”保持当前位置
          if (hasLL) {
            action = (currentShownDevId === devId) ? 'move-ll' : 'move-ll';
            target = ll;
            try { infoWindow.setPosition(target); } catch(e){}
          } else {
            action = 'stay';
            // 可见性保险：若意外被关闭或未绘制，强制在默认处打开
            try {
              var cur = infoWindow.getPosition && infoWindow.getPosition();
              if (!cur) { infoWindow.open(map, defaultPosArray()); infoWindowOpen = true; action = 'open-default'; target = defaultPosArray(); }
            } catch(e){}
          }
        }

        // 以实际显示位置回写 lastInfoPos（稳定为数值）
        try{
          var p = infoWindow.getPosition && infoWindow.getPosition();
          if (p) lastInfoPos = { lng: Number(p.lng), lat: Number(p.lat) };
        }catch(e){}

        currentShownDevId = devId;
        sendDataToChild();
        log('update infoWindow', { devId:devId, shown:currentShownDevId, opened:infoWindowOpen, hasLL:hasLL, action:action, pos:target, lastInfoPos:lastInfoPos });
      }

      function setCenter(lng,lat){ try{ map&&map.setCenter([lng,lat]); }catch(e){} }
      function resize(){ try{ map&&map.resize(); }catch(e){} }

      window.addEventListener('message', function(e){
        var msg=e.data||{};
        // 子 iframe -> 父
        if (msg && msg.__iv && e.source === (infoFrame && infoFrame.contentWindow)) {
          switch(msg.t){
            case 'ready':
              sendDataToChild();
              break;
            case 'height':
              if (infoFrame) {
                try{ infoFrame.style.height = Math.max(10, Number(msg.h||0)) + 'px'; }catch(e){}
              }
              break;
            case 'close':
              try{ infoWindow && infoWindow.close(); infoWindowOpen=false; }catch(e){}
              break;
            case 'openDetail':
              post({ t:'openDetail', devId: msg.devId, devNo: msg.devNo });
              break;
            case 'refreshDevice':
              post({ t:'refreshDevice', devId: msg.devId });
              break;
            case 'openVideo':
              post({ t:'openVideo', devId: msg.devId, devNo: msg.devNo, cameraIndex: msg.cameraIndex, streamType: msg.streamType });
              break;
            case 'openMode':
              post({ t:'openMode', devId: msg.devId, devNo: msg.devNo, modeId: msg.modeId });
              break;
            case 'req_show_addr':
              ensureGeocoder(function(){
                if (!geocoder) {
                  try{ infoFrame.contentWindow.postMessage({ __iv:true, t:'res_addr', text:'逆地理失败' }, '*'); }catch(e){}
                  return;
                }
                geocoder.getAddress([msg.lng, msg.lat], function(status, result){
                  var text = (status === 'complete' && result && result.regeocode && result.regeocode.formattedAddress)
                    ? result.regeocode.formattedAddress : '未找到地址';
                  try{ infoFrame.contentWindow.postMessage({ __iv:true, t:'res_addr', text: text }, '*'); }catch(e){}
                });
              });
              break;
          }
          return;
        }

        // 父(上层) -> 本页
        if(!msg.__mv) return;
        switch(msg.t){
          case "init":
            AMAP_KEY = (msg.key || "").trim();
            SECURITY_JS_CODE = (msg.securityJsCode || "").trim();
            debug = !!msg.debug;
            ensureAMap(init);
            break;
          case "setMarkers": setMarkers(msg.list||[]); break;
          case "openDevice": openDevice(msg.devInfo||{}, !!msg.followCenterWhenNoLocation); break;
          case "setCenter": setCenter(msg.lng, msg.lat); break;
          case "resize": resize(); break;
        }
      }, { capture:true, passive:true });
    })();
  </script>
</body>
</html>